# go-musthave-metrics-tpl

Шаблон репозитория для трека «Сервер сбора метрик и алертинга».

## Начало работы

1. Склонируйте репозиторий в любую подходящую директорию на вашем компьютере.
2. В корне репозитория выполните команду `go mod init <name>` (где `<name>` — адрес вашего репозитория на GitHub без префикса `https://`) для создания модуля.

## Обновление шаблона

Чтобы иметь возможность получать обновления автотестов и других частей шаблона, выполните команду:

```
git remote add -m main template https://github.com/Yandex-Practicum/go-musthave-metrics-tpl.git
```

Для обновления кода автотестов выполните команду:

```
git fetch template && git checkout template/main .github
```

Затем добавьте полученные изменения в свой репозиторий.

## Запуск автотестов

Для успешного запуска автотестов называйте ветки `iter<number>`, где `<number>` — порядковый номер инкремента. Например, в ветке с названием `iter4` запустятся автотесты для инкрементов с первого по четвёртый.

При мёрже ветки с инкрементом в основную ветку `main` будут запускаться все автотесты.

Подробнее про локальный и автоматический запуск читайте в [README автотестов](https://github.com/Yandex-Practicum/go-autotests).



## Инкримент 6
Задание по треку «Сервис сбора метрик и алертинга»
Реализуйте логирование сведений о запросах и ответах на сервере для всех эндпоинтов, которые у вас уже есть.

    Сведения о запросах должны содержать URI, метод запроса и время, затраченное на его выполнение.
    Сведения об ответах должны содержать код статуса и размер содержимого ответа.

Эту функциональность нужно реализовать через middleware. Используйте один из сторонних пакетов для логирования:

    github.com/rs/zerolog,
    go.uber.org/zap,
    github.com/sirupsen/logrus.

Все сообщения логера должны быть на уровне Info.

## Инкримент 7
Дополните API сервера, чтобы позволить ему принимать метрики в формате JSON.
При реализации задействуйте одну из распространённых библиотек:

    encoding/json,
    github.com/mailru/easyjson,
    github.com/pquerna/ffjson.

Обмен с сервером организуйте с использованием следующей структуры:

  type Metrics struct {
     ID    string   `json:"id"`              // имя метрики
     MType string   `json:"type"`            // параметр, принимающий значение gauge или counter
     Delta *int64   `json:"delta,omitempty"` // значение метрики в случае передачи counter
     Value *float64 `json:"value,omitempty"` // значение метрики в случае передачи gauge
  }

Для передачи метрик на сервер используйте Content-Type: application/json. В теле запроса должен быть описанный выше JSON. Передавать метрики нужно через POST update/. В теле ответа отправляйте JSON той же структуры с актуальным (изменённым) значением Value.
Для получения метрик с сервера также используйте Content-Type: application/json. В теле запроса должен быть описанный выше JSON с заполненными полями ID и MType. Запрашивать нужно через POST value/. В теле ответа должен приходить такой же JSON, но с уже заполненными значениями метрик.
Переведите агент на новый API.
Автотесты проверяют, что агент экспортирует и обновляет на сервере метрики, описанные в первых инкрементах.

## Инкримент 8

Добавьте поддержку gzip в код сервера и агента. Научите:

    Агент передавать данные в формате gzip.
    Сервер опционально принимать запросы в сжатом формате (при наличии соответствующего HTTP-заголовка Content-Encoding).
    Отдавать сжатый ответ клиенту, который поддерживает обработку сжатых ответов (с HTTP-заголовком Accept-Encoding).

Функция сжатия должна работать для контента с типами application/json и text/html.
Вспомните middleware из урока про HTTP-сервер, это может вам помочь.

## Инкриент 9

Доработайте код сервера, чтобы он мог с заданной периодичностью сохранять текущие значения метрик на диск в указанный файл, а на старте — опционально загружать сохранённые ранее значения. При штатном завершении сервера все накопленные данные должны сохраняться.
Сервер должен принимать соответствующие параметры конфигурации через флаги и переменные окружения:

    Флаг -i, переменная окружения STORE_INTERVAL — интервал времени в секундах, по истечении которого текущие показания сервера сохраняются на диск (по умолчанию 300 секунд, значение 0 делает запись синхронной).
    Флаг -f, переменная окружения FILE_STORAGE_PATH — полное имя файла, куда сохраняются текущие значения (по умолчанию /tmp/metrics-db.json, пустое значение отключает функцию записи на диск).
    Флаг -r, переменная окружения RESTORE — булево значение (true/false), определяющее, загружать или нет ранее сохранённые значения из указанного файла при старте сервера (по умолчанию true).

Приоритет параметров сервера должен быть таким:

    Если указана переменная окружения, то используется она.
    Если нет переменной окружения, но есть флаг, то используется он.
    Если нет ни переменной окружения, ни флага, то используется значение по умолчанию.
